pipeline {
    agent { label 'petshop-host' }

    environment {
        PROJECT_PATH = "/home/ubuntu/Pet_Shop/PetShopCG"
        JAR_NAME = "target/PetShop_CG-0.0.1-SNAPSHOT.jar"
        PORT = "9090"
        SERVICE_NAME = "petshop.service"
        LOG_PATH = "/var/log/petshopcg/app.log" 
}


    stages {
        stage('Pull latest code from dev branch') {
            steps {
                dir("${PROJECT_PATH}") {
                    sh '''
                        echo "üîÑ Fetching latest changes from dev branch..."
                        git fetch origin
                        git reset --hard origin/dev
                        git clean -fd
                    '''
                }
            }
        }

        stage('Build with Maven') {
            steps {
                dir("${PROJECT_PATH}") {
                    sh 'sudo mvn clean package -DskipTests'
                }
            }
        }

        stage('Build and Restart application') {
    steps {
        dir("${PROJECT_PATH}") {
            sh '''
                echo "üîÑ Building with Maven..."
                sudo mvn clean package

                echo "üõë Restarting existing service ${SERVICE_NAME}..."
                sudo systemctl restart ${SERVICE_NAME}

                echo "‚è≥ Waiting for service to start..."
                sleep 10

                echo "üîç Checking service status..."
                sudo systemctl status ${SERVICE_NAME} --no-pager || echo "‚ö†Ô∏è Service may have failed"

                echo "üìú Last 20 lines of app.log:"
                tail -n 20 ${LOG_PATH} || echo "‚ö†Ô∏è app.log not found or empty"
            '''
        }
    }
}


    }

    post {
        success {
            echo '‚úÖ App built and deployed on port 9090.'
        }
        failure {
            echo '‚ùå Pipeline failed. Review app.log and Jenkins console output.'
        }
    }
}
